#!/bin/bash

# == SET VARIABLES ==
API_KEY=$(cat $HOME/.config/footy/api_key.txt)
FOOTY=$(basename "$0")
FOOTY_FULL="$0"
# export TODO_SH TODO_FULL_SH
USAGE="$FOOTY [-s <league>] [-k <api-key>] [-l] [-t <league>] [-h]"

# == FUNCTIONS FOR OPTIONS ==
usage()
{
	cat <<-EOF >&2
	Usage: $USAGE
	Try '$FOOTY -h' for more information.
	EOF
	exit 1
}

shorthelp()
{
	cat <<-EOF
	Usage: $USAGE
	-s <league>   Prints standings in a league (use league's code or id).
	-k <api-key>  Saves the api-key to \$HOME/.config/footy/api_key.txt
	-l            Prints all supported leagues.
	-t <league>   Prints all teams in a league (use league's code or id).
	-h            Prints this user documentation.
	EOF
	exit 0
}

set_key()
{
	mkdir -p $HOME/.config/footy
	echo "${OPTARG}" > $HOME/.config/footy/api_key.txt
	exit 0
}

leagues()
{
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions | \
		jq -r '.competitions[] | "\(.area.name),\(.name),\(.code),\(.id),\(.plan)"' | \
		awk '{ $3 = ($3 == "null" ? "" : $3); $6 = ($5 == "TIER_ONE" ? "Free" : "" ) } 1' FS="," OFS="," | \
		column -ts "," -N Area,Name,Code,Id,Plan,Price -R Id -H Plan
	exit 0
}

teams()
{
	# TODO: adjust date to current season properly
	SEASON=$(date +"%Y")
	COMP=${OPTARG}
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions/$COMP/teams?season=2021 | \
		jq -r '.teams[] | "\(.name),\(.tla),\(.id)"' | \
		awk '{ $2 = ($2 == "null" ? "" : $2) } 1' FS="," OFS="," | \
		column -ts "," -N Name,Code,Id -R Id
	exit 0
}

standings()
{
	COMPETITION=${OPTARG}
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions/$COMPETITION/standings | \
		jq -r '.standings[0].table[] | "\(.position),\(.team.name),\(.playedGames),\(.won),\(.draw),\(.lost),\(.points)"' | \
		column -ts "," -N Pos,Team,P,W,D,L,Pts -R Pos,P,W,D,L,Pts
	exit 0
}

matches()
{
	# TODO: add support for teams as well
	# TODO: +<days> searches for upcoming, -<days> searches for past
	DAYS=${OPTARG}
	DATE_FROM=$(date -d "$date -$DAYS days" +"%Y-%m-%d")
	DATE_TO=$(date +"%Y-%m-%d")
	COMPETITION=BL1
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions/$COMPETITION/matches\?dateFrom=$DATE_FROM\&dateTo=$DATE_TO | \
		jq -r '.matches[] | "\(.homeTeam.name),\(.awayTeam.name),\(.score.fullTime.homeTeam):\(.score.fullTime.awayTeam)"' | \
		awk '{ $3 = ($3 == "null:null" ? "-:-" : $3) } 1' FS="," OFS="," | \
		column -ts "," -N Home,Away,Score
	exit 0
}

# == PROCESS OPTIONS ==
while getopts ":hk:lt:s:m:" opt; do
	case "${opt}" in
		h)
			shorthelp
			;;
		k)
			set_key
			;;
		l)
			leagues
			;;
		t)
			teams
			;;
		s)
			standings
			;;
		m)
			matches
			;;
		*)
			usage
			;;
	esac
done

usage; exit 0
