#!/bin/bash

# == SET VARIABLES ==
API_KEY=$(cat $HOME/.config/footy/api_key.txt)
# Set script name and full path
FOOTY=$(basename "$0")
FOOTY_FULL="$0"
# export TODO_SH TODO_FULL_SH
USAGE="$FOOTY [-s <league>] [-k <api-key>] [-l] [-t] [-h]"

# == FUNCTIONS FOR OPTIONS ==
usage()
{
	cat <<-EOF >&2
	Usage: $USAGE
	Try '$FOOTY -h' for more information.
	EOF
	exit 1
}

shorthelp()
{
	cat <<-EOF
	Usage: $USAGE
	-s [<code>|<id>]  Prints standings in league (specified by the league's code or id).
	-k <api-key>      Saves the api-key to \$HOME/.config/footy/api_key.txt
	-l                Prints all supported leagues.
	-t                Prints all supported teams.
	-h                Prints this user documentation.
	EOF
	exit 0
}

set_key()
{
	mkdir -p $HOME/.config/footy
	echo "${OPTARG}" > $HOME/.config/footy/api_key.txt
	exit 0
}

leagues()
{
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions | \
		jq -r '.competitions[] | "\(.area.name),\(.name),\(.code),\(.id),\(.plan)"' | \
		awk '{ $3 = ($3 == "null" ? "" : $3); $6 = ($5 == "TIER_ONE" ? "Free" : "" )} 1' FS="," OFS="," | \
		column -ts "," -N Area,Name,Code,Id,Plan,Price -R Id -H Plan
	exit 0
}

teams()
{
	# TODO: only works for England, make work for all countries
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/teams | \
		jq -r '.teams[] | "\(.area.name),\(.name),\(.tla),\(.id)"' | \
		# awk '{ $3 = ($3 == "null" ? "" : $3); $6 = ($5 == "TIER_ONE" ? "Free" : "" )} 1' FS="," OFS="," | \
		column -ts "," -N Area,Name,Code,Id -R Id
	exit 0
}

standings()
{
	COMPETITION=${OPTARG}
	curl -sH "X-Auth-Token: $API_KEY" https://api.football-data.org/v2/competitions/$COMPETITION/standings | \
		jq -r '.standings[0].table[] | "\(.position),\(.team.name),\(.playedGames),\(.won),\(.draw),\(.lost),\(.points)"' | \
		column -ts "," -N Pos,Team,P,W,D,L,Pts -R Pos,P,W,D,L,Pts
	exit 0
}

# == PROCESS OPTIONS ==
while getopts ":s:k:lth" opt; do
	case "${opt}" in
		h)
			shorthelp
			;;
		k)
			set_key
			;;
		l)
			leagues
			;;
		t)
			teams
			;;
		s)
			standings
			;;
		*)
			usage
			;;
	esac
done
